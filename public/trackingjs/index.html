<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>tracking.js - face with camera</title>
  <!-- <link rel="stylesheet" href="assets/demo.css"> -->

  <script src="/socket.io/socket.io.js"></script>
  <script src="./js/tracking.min.js"></script>
  <script src="./js/face.min.js"></script>
  <script src="./js/dat.gui.min.js"></script>

  <style>
  .demo-container {
    width:640px;
    height:480px;
    position: relative;
    overflow: hidden;
  }
  video, canvas {
    position: absolute;
  }
  #heart {
    position: absolute;
    animation: all 0.1s ease-in;
    font-size:45px;
    color:red;
    display:inline-block;
  }
  </style>
</head>
<body>
<h3>heartbeat with tracking.js</h3>
  <div class="demo-frame">
    <div class="demo-container">
      <video id="video" width="640" height="480" preload autoplay loop muted></video>
      <canvas id="canvas" width="640" height="480"></canvas>
      <div id="heart" style="">♥️</div>
    </div>
  </div>
  <div id="bpm"></div>


  <script>
    window.onload = function() {
      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');

      var tracker = new tracking.ObjectTracker('face');
      tracker.setInitialScale(4);
      tracker.setStepSize(2);
      tracker.setEdgesDensity(0.1);

      tracking.track('#video', tracker, { camera: true });

      tracker.on('track', function(event) {
        context.clearRect(0, 0, canvas.width, canvas.height);

        event.data.forEach(function(rect) {
          context.strokeStyle = '#a64ceb';
          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
          context.font = '11px Helvetica';
          context.fillStyle = "#fff";
          context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
          context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
          document.getElementById('heart').style.left = (rect.x + (rect.width/2)) + 'px';
          document.getElementById('heart').style.top = (rect.y + rect.height + 100) + 'px';
        });
      });

      var gui = new dat.GUI();
      gui.add(tracker, 'edgesDensity', 0.1, 0.5).step(0.01);
      gui.add(tracker, 'initialScale', 1.0, 10.0).step(0.1);
      gui.add(tracker, 'stepSize', 1, 5).step(0.1);


      function applyBpm(bpm) {
        var d=document.getElementById("heart");
        var bpmdiv=document.getElementById("bpm");
        bpmdiv.innerHTML = bpm;
        var size = 45;
        //d.removeAttribute('animation');
        if (bpm < 60) {
           size *= 1.5;
        }
        if (bpm >= 60 && bpm < 70) {
            size *= 1.8;
        }
         if (bpm >= 70 && bpm < 80) {
            size *= 2.5;
        }
          if (bpm >= 80 && bpm < 120) {
              size *= 2.8;
        }
          if (bpm >= 120 ) {
              size *= 3;
        }
       // var anim = 'property: scale; dir: alternate-reverse; dur: ' + dur + ';loop: true; from: 1 ;to: 1.5';
       // d.setAttribute('animation', anim);
       d.style.fontSize = size + 'px';
       setTimeout(() => {
        d.style.fontSize = '45px';
       }, 100)
      }


      var peak_detect_offset = 20;
      var peak_mininum_interval = 300;


        var socket = io.connect('/'),
            pulse_data = [],
            totalPoints = 100,
            lastPeak = Date.now(),
            peakDiffs = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            freq = 0;

        var drawFinished = true;

        var bpm = 0;
        socket.on('pulse', function (data) {
          //console.log("pulse", data)
          if (!drawFinished) {
            return;
          }
          drawFinished = false;

          pulse_data.push(data)
          pulse_data.shift();

          if (data > (pulse_data[totalPoints - 10] + peak_detect_offset)) {
            freq = Date.now() - lastPeak;
            // debounce
            if (freq > peak_mininum_interval) {
              lastPeak = Date.now();
              peakDiffs.push(freq);
              peakDiffs.shift();
              var heart_rate = parseInt(60 * 1000 / freq * 100 / 100, 10)
              // remove aberations
              if (heart_rate > 50 && heart_rate < 150) {
                bpm = heart_rate
                window.navigator.vibrate([100, 50, 100]);
                console.log("bpm", bpm)
                applyBpm(bpm)
              } else {
                //$('#heartrate').html("0");
              }
            }
          }
          drawFinished = true;
        });

        // pre-fill pulse_data with all zeroes
        while (pulse_data.length < totalPoints) {
          pulse_data.push(0);
        }

        var parse_data = function () {
          var res = [],
              min = max = pulse_data[0];

          for (var i = 0; i < pulse_data.length; ++i) {
            if (max < pulse_data[i]) { max = pulse_data[i]; }
            if (min < pulse_data[i]) { min = pulse_data[i]; }

            res.push([i, pulse_data[i] ])
          }

          return res;
        }


    };
  </script>

</body>
</html>